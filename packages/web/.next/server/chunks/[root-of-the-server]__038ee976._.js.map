{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///home/nodes/development/actual-nextgen/packages/web/src/server/db/sqlite.ts"],"sourcesContent":["/**\n * Thin SQLite wrapper — mirrors sync-server's db.js but typed.\n * Always runs server-side only (never bundled for the browser).\n */\nimport Database from 'better-sqlite3';\n\ntype Params = ReadonlyArray<string | number | null | Buffer>;\n\ntype MutateResult = { changes: number; insertId: number | bigint };\n\nclass WrappedDatabase {\n  private readonly db: Database.Database;\n\n  constructor(db: Database.Database) {\n    this.db = db;\n  }\n\n  all<T = Record<string, unknown>>(sql: string, params: Params = []): T[] {\n    const stmt = this.db.prepare(sql);\n    return stmt.all(...params) as T[];\n  }\n\n  first<T = Record<string, unknown>>(\n    sql: string,\n    params: Params = [],\n  ): T | null {\n    const rows = this.all<T>(sql, params);\n    return rows.length === 0 ? null : rows[0];\n  }\n\n  exec(sql: string): void {\n    this.db.exec(sql);\n  }\n\n  mutate(sql: string, params: Params = []): MutateResult {\n    const stmt = this.db.prepare(sql);\n    const info = stmt.run(...params);\n    return { changes: info.changes, insertId: info.lastInsertRowid };\n  }\n\n  transaction<T>(fn: () => T): T {\n    return this.db.transaction(fn)();\n  }\n\n  close(): void {\n    this.db.close();\n  }\n}\n\nexport type Db = WrappedDatabase;\n\nexport function openDatabase(filename: string): Db {\n  return new WrappedDatabase(new Database(filename));\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;AACD;;AAMA,MAAM;IACa,GAAsB;IAEvC,YAAY,EAAqB,CAAE;QACjC,IAAI,CAAC,EAAE,GAAG;IACZ;IAEA,IAAiC,GAAW,EAAE,SAAiB,EAAE,EAAO;QACtE,MAAM,OAAO,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC;QAC7B,OAAO,KAAK,GAAG,IAAI;IACrB;IAEA,MACE,GAAW,EACX,SAAiB,EAAE,EACT;QACV,MAAM,OAAO,IAAI,CAAC,GAAG,CAAI,KAAK;QAC9B,OAAO,KAAK,MAAM,KAAK,IAAI,OAAO,IAAI,CAAC,EAAE;IAC3C;IAEA,KAAK,GAAW,EAAQ;QACtB,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC;IACf;IAEA,OAAO,GAAW,EAAE,SAAiB,EAAE,EAAgB;QACrD,MAAM,OAAO,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC;QAC7B,MAAM,OAAO,KAAK,GAAG,IAAI;QACzB,OAAO;YAAE,SAAS,KAAK,OAAO;YAAE,UAAU,KAAK,eAAe;QAAC;IACjE;IAEA,YAAe,EAAW,EAAK;QAC7B,OAAO,IAAI,CAAC,EAAE,CAAC,WAAW,CAAC;IAC7B;IAEA,QAAc;QACZ,IAAI,CAAC,EAAE,CAAC,KAAK;IACf;AACF;AAIO,SAAS,aAAa,QAAgB;IAC3C,OAAO,IAAI,gBAAgB,IAAI,sIAAQ,CAAC;AAC1C","debugId":null}},
    {"offset": {"line": 116, "column": 0}, "map": {"version":3,"sources":["file:///home/nodes/development/actual-nextgen/packages/web/src/server/db/paths.ts"],"sourcesContent":["import { join, resolve } from 'node:path';\n\n/**\n * Data directory — defaults to ./data, overridden via DATA_DIR env var.\n * In Docker this is a mounted volume at /data.\n */\nexport const dataDir = resolve(process.env.DATA_DIR ?? './data');\nexport const serverFilesDir = join(dataDir, 'server-files');\nexport const userFilesDir = join(dataDir, 'user-files');\n\nexport function getPathForUserFile(fileId: string): string {\n  return join(resolve(userFilesDir), `file-${fileId}.blob`);\n}\n\nexport function getPathForGroupFile(groupId: string): string {\n  return join(resolve(userFilesDir), `group-${groupId}.sqlite`);\n}\n\nexport function getAccountDbPath(): string {\n  return join(resolve(serverFilesDir), 'account.sqlite');\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAMO,MAAM,UAAU,IAAA,4HAAO,EAAC,QAAQ,GAAG,CAAC,QAAQ,IAAI;AAChD,MAAM,iBAAiB,IAAA,yHAAI,EAAC,SAAS;AACrC,MAAM,eAAe,IAAA,yHAAI,EAAC,SAAS;AAEnC,SAAS,mBAAmB,MAAc;IAC/C,OAAO,IAAA,yHAAI,EAAC,IAAA,4HAAO,EAAC,eAAe,CAAC,KAAK,EAAE,OAAO,KAAK,CAAC;AAC1D;AAEO,SAAS,oBAAoB,OAAe;IACjD,OAAO,IAAA,yHAAI,EAAC,IAAA,4HAAO,EAAC,eAAe,CAAC,MAAM,EAAE,QAAQ,OAAO,CAAC;AAC9D;AAEO,SAAS;IACd,OAAO,IAAA,yHAAI,EAAC,IAAA,4HAAO,EAAC,iBAAiB;AACvC","debugId":null}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///home/nodes/development/actual-nextgen/packages/web/src/server/db/account-db.ts"],"sourcesContent":["/**\n * Account database operations — server-side only.\n * Ports packages/sync-server/src/account-db.js to typed TypeScript.\n * The account DB stores: auth methods, sessions, users, user_access, server_prefs.\n */\nimport { mkdirSync } from 'node:fs';\nimport { dirname } from 'node:path';\n\nimport { type Db, openDatabase } from './sqlite';\nimport { getAccountDbPath } from './paths';\n\n// ─── Schema ─────────────────────────────────────────────────────────────────\n\nconst SCHEMA = `\nPRAGMA journal_mode=WAL;\n\nCREATE TABLE IF NOT EXISTS auth (\n  method       TEXT PRIMARY KEY,\n  display_name TEXT NOT NULL,\n  extra_data   TEXT,\n  active       INTEGER NOT NULL DEFAULT 0\n);\n\nCREATE TABLE IF NOT EXISTS sessions (\n  token       TEXT PRIMARY KEY,\n  expires_at  INTEGER NOT NULL,\n  user_id     TEXT,\n  auth_method TEXT\n);\n\nCREATE TABLE IF NOT EXISTS users (\n  id           TEXT PRIMARY KEY,\n  user_name    TEXT NOT NULL,\n  display_name TEXT,\n  enabled      INTEGER NOT NULL DEFAULT 1,\n  owner        INTEGER NOT NULL DEFAULT 0,\n  role         TEXT NOT NULL DEFAULT 'BASIC'\n);\n\nCREATE TABLE IF NOT EXISTS files (\n  id              TEXT PRIMARY KEY,\n  group_id        TEXT,\n  sync_version    TEXT,\n  name            TEXT NOT NULL,\n  encrypt_meta    TEXT,\n  encrypt_salt    TEXT,\n  encrypt_key_id  TEXT,\n  encrypt_test    TEXT,\n  owner           TEXT NOT NULL,\n  deleted         INTEGER NOT NULL DEFAULT 0\n);\n\nCREATE TABLE IF NOT EXISTS user_access (\n  user_id TEXT NOT NULL,\n  file_id TEXT NOT NULL,\n  PRIMARY KEY (user_id, file_id)\n);\n\nCREATE TABLE IF NOT EXISTS server_prefs (\n  key   TEXT PRIMARY KEY,\n  value TEXT NOT NULL\n);\n`;\n\n// ─── Singleton DB ────────────────────────────────────────────────────────────\n\nlet _accountDb: Db | undefined;\n\nexport function getAccountDb(): Db {\n  if (_accountDb === undefined) {\n    const path = getAccountDbPath();\n    mkdirSync(dirname(path), { recursive: true });\n    _accountDb = openDatabase(path);\n    _accountDb.exec(SCHEMA);\n  }\n  return _accountDb;\n}\n\n// ─── Types ───────────────────────────────────────────────────────────────────\n\nexport type Session = {\n  token: string;\n  expires_at: number;\n  user_id: string;\n  auth_method: string;\n};\n\nexport type User = {\n  id: string;\n  user_name: string;\n  display_name: string | null;\n  enabled: number;\n  owner: number;\n  role: string;\n};\n\nexport type AuthRow = {\n  method: string;\n  display_name: string;\n  extra_data: string | null;\n  active: number;\n};\n\n// ─── Session operations ──────────────────────────────────────────────────────\n\nexport const TOKEN_EXPIRATION_NEVER = -1;\n\nexport function getSession(token: string): Session | null {\n  return getAccountDb().first<Session>('SELECT * FROM sessions WHERE token = ?', [\n    token,\n  ]);\n}\n\nexport function clearExpiredSessions(): void {\n  const clearThreshold = Math.floor(Date.now() / 1000) - 3600;\n  const { changes } = getAccountDb().mutate(\n    'DELETE FROM sessions WHERE expires_at <> -1 AND expires_at < ?',\n    [clearThreshold],\n  );\n  if (changes > 0) {\n    console.log(`Cleared ${changes} expired sessions`);\n  }\n}\n\n// ─── Auth / bootstrap ────────────────────────────────────────────────────────\n\nexport function needsBootstrap(): boolean {\n  const rows = getAccountDb().all('SELECT * FROM auth');\n  return rows.length === 0;\n}\n\nexport function listLoginMethods(): Array<{\n  method: string;\n  active: boolean;\n  displayName: string;\n}> {\n  const rows = getAccountDb().all<AuthRow>(\n    'SELECT method, display_name, active FROM auth',\n  );\n  return rows.map((r) => ({\n    method: r.method,\n    active: r.active === 1,\n    displayName: r.display_name,\n  }));\n}\n\nexport function getActiveLoginMethod(): string | null {\n  const row = getAccountDb().first<{ method: string }>(\n    'SELECT method FROM auth WHERE active = 1',\n  );\n  return row?.method ?? null;\n}\n\nexport function getLoginMethod(\n  requestedMethod?: string | null,\n): string {\n  if (requestedMethod) {\n    return requestedMethod;\n  }\n  return getActiveLoginMethod() ?? 'password';\n}\n\n// ─── User operations ─────────────────────────────────────────────────────────\n\nexport function getUserInfo(userId: string): User | null {\n  return getAccountDb().first<User>('SELECT * FROM users WHERE id = ?', [userId]);\n}\n\nexport function getUserPermission(userId: string): string {\n  const row = getAccountDb().first<{ role: string }>(\n    'SELECT role FROM users WHERE id = ?',\n    [userId],\n  );\n  return row?.role ?? '';\n}\n\nexport function isAdmin(userId: string): boolean {\n  return getUserPermission(userId) === 'ADMIN';\n}\n\n// ─── Server prefs ────────────────────────────────────────────────────────────\n\nexport function getServerPrefs(): Record<string, string> {\n  const rows = getAccountDb().all<{ key: string; value: string }>(\n    'SELECT key, value FROM server_prefs',\n  );\n  return Object.fromEntries(rows.map((r) => [r.key, r.value]));\n}\n\nexport function setServerPrefs(prefs: Record<string, string>): void {\n  const db = getAccountDb();\n  db.transaction(() => {\n    for (const [key, value] of Object.entries(prefs)) {\n      db.mutate(\n        'INSERT INTO server_prefs (key, value) VALUES (?, ?) ON CONFLICT (key) DO UPDATE SET value = excluded.value',\n        [key, value],\n      );\n    }\n  });\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACD;AACA;AAEA;AACA;;;;;AAEA,+EAA+E;AAE/E,MAAM,SAAS,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiDhB,CAAC;AAED,gFAAgF;AAEhF,IAAI;AAEG,SAAS;IACd,IAAI,eAAe,WAAW;QAC5B,MAAM,OAAO,IAAA,qKAAgB;QAC7B,IAAA,0HAAS,EAAC,IAAA,4HAAO,EAAC,OAAO;YAAE,WAAW;QAAK;QAC3C,aAAa,IAAA,kKAAY,EAAC;QAC1B,WAAW,IAAI,CAAC;IAClB;IACA,OAAO;AACT;AA6BO,MAAM,yBAAyB,CAAC;AAEhC,SAAS,WAAW,KAAa;IACtC,OAAO,eAAe,KAAK,CAAU,0CAA0C;QAC7E;KACD;AACH;AAEO,SAAS;IACd,MAAM,iBAAiB,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK,QAAQ;IACvD,MAAM,EAAE,OAAO,EAAE,GAAG,eAAe,MAAM,CACvC,kEACA;QAAC;KAAe;IAElB,IAAI,UAAU,GAAG;QACf,QAAQ,GAAG,CAAC,CAAC,QAAQ,EAAE,QAAQ,iBAAiB,CAAC;IACnD;AACF;AAIO,SAAS;IACd,MAAM,OAAO,eAAe,GAAG,CAAC;IAChC,OAAO,KAAK,MAAM,KAAK;AACzB;AAEO,SAAS;IAKd,MAAM,OAAO,eAAe,GAAG,CAC7B;IAEF,OAAO,KAAK,GAAG,CAAC,CAAC,IAAM,CAAC;YACtB,QAAQ,EAAE,MAAM;YAChB,QAAQ,EAAE,MAAM,KAAK;YACrB,aAAa,EAAE,YAAY;QAC7B,CAAC;AACH;AAEO,SAAS;IACd,MAAM,MAAM,eAAe,KAAK,CAC9B;IAEF,OAAO,KAAK,UAAU;AACxB;AAEO,SAAS,eACd,eAA+B;IAE/B,IAAI,iBAAiB;QACnB,OAAO;IACT;IACA,OAAO,0BAA0B;AACnC;AAIO,SAAS,YAAY,MAAc;IACxC,OAAO,eAAe,KAAK,CAAO,oCAAoC;QAAC;KAAO;AAChF;AAEO,SAAS,kBAAkB,MAAc;IAC9C,MAAM,MAAM,eAAe,KAAK,CAC9B,uCACA;QAAC;KAAO;IAEV,OAAO,KAAK,QAAQ;AACtB;AAEO,SAAS,QAAQ,MAAc;IACpC,OAAO,kBAAkB,YAAY;AACvC;AAIO,SAAS;IACd,MAAM,OAAO,eAAe,GAAG,CAC7B;IAEF,OAAO,OAAO,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM;YAAC,EAAE,GAAG;YAAE,EAAE,KAAK;SAAC;AAC5D;AAEO,SAAS,eAAe,KAA6B;IAC1D,MAAM,KAAK;IACX,GAAG,WAAW,CAAC;QACb,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,OAAO,OAAO,CAAC,OAAQ;YAChD,GAAG,MAAM,CACP,8GACA;gBAAC;gBAAK;aAAM;QAEhB;IACF;AACF","debugId":null}},
    {"offset": {"line": 325, "column": 0}, "map": {"version":3,"sources":["file:///home/nodes/development/actual-nextgen/packages/web/src/server/db/files-service.ts"],"sourcesContent":["/**\n * Files service — manages budget file metadata in account.sqlite.\n * Ports sync-server/src/app-sync/services/files-service.js to TypeScript.\n */\nimport { getAccountDb } from './account-db';\n\nexport type FileRow = {\n  id: string;\n  groupId: string | null;\n  syncVersion: string | null;\n  name: string;\n  encryptMeta: string | null;\n  encryptSalt: string | null;\n  encryptKeyId: string | null;\n  encryptTest: string | null;\n  owner: string;\n  deleted: number;\n};\n\ntype RawFileRow = {\n  id: string;\n  group_id: string | null;\n  sync_version: string | null;\n  name: string;\n  encrypt_meta: string | null;\n  encrypt_salt: string | null;\n  encrypt_key_id: string | null;\n  encrypt_test: string | null;\n  owner: string;\n  deleted: number;\n};\n\nexport class FileNotFound extends Error {\n  constructor(fileId: string) {\n    super(`File not found: ${fileId}`);\n  }\n}\n\nfunction fromRow(row: RawFileRow): FileRow {\n  return {\n    id: row.id,\n    groupId: row.group_id,\n    syncVersion: row.sync_version,\n    name: row.name,\n    encryptMeta: row.encrypt_meta,\n    encryptSalt: row.encrypt_salt,\n    encryptKeyId: row.encrypt_key_id,\n    encryptTest: row.encrypt_test,\n    owner: row.owner,\n    deleted: row.deleted,\n  };\n}\n\nexport function getFile(fileId: string): FileRow {\n  const row = getAccountDb().first<RawFileRow>(\n    `SELECT id, group_id, sync_version, name, encrypt_meta, encrypt_salt,\n            encrypt_key_id, encrypt_test, owner, deleted\n     FROM files WHERE id = ?`,\n    [fileId],\n  );\n  if (!row) throw new FileNotFound(fileId);\n  return fromRow(row);\n}\n\nexport function findFiles(params: { userId: string }): FileRow[] {\n  const rows = getAccountDb().all<RawFileRow>(\n    `SELECT f.id, f.group_id, f.sync_version, f.name, f.encrypt_meta,\n            f.encrypt_salt, f.encrypt_key_id, f.encrypt_test, f.owner, f.deleted\n     FROM files f\n     WHERE f.owner = ? OR EXISTS (\n       SELECT 1 FROM user_access ua WHERE ua.file_id = f.id AND ua.user_id = ?\n     )`,\n    [params.userId, params.userId],\n  );\n  return rows.map(fromRow);\n}\n\ntype SetFileParams = {\n  id: string;\n  groupId: string | null;\n  syncVersion: string | null;\n  name: string;\n  encryptMeta: string | null;\n  owner: string;\n};\n\nexport function setFile(params: SetFileParams): void {\n  getAccountDb().mutate(\n    `INSERT INTO files (id, group_id, sync_version, name, encrypt_meta, owner, deleted)\n     VALUES (?, ?, ?, ?, ?, ?, 0)`,\n    [\n      params.id,\n      params.groupId,\n      params.syncVersion,\n      params.name,\n      params.encryptMeta,\n      params.owner,\n    ],\n  );\n}\n\ntype UpdateFileParams = {\n  groupId?: string | null;\n  syncVersion?: string | null;\n  name?: string;\n  encryptMeta?: string | null;\n  encryptSalt?: string | null;\n  encryptKeyId?: string | null;\n  encryptTest?: string | null;\n  deleted?: boolean;\n};\n\nexport function updateFile(fileId: string, params: UpdateFileParams): void {\n  const db = getAccountDb();\n\n  if ('groupId' in params) {\n    db.mutate('UPDATE files SET group_id = ? WHERE id = ?', [\n      params.groupId ?? null,\n      fileId,\n    ]);\n  }\n  if ('syncVersion' in params) {\n    db.mutate('UPDATE files SET sync_version = ? WHERE id = ?', [\n      params.syncVersion ?? null,\n      fileId,\n    ]);\n  }\n  if ('name' in params && params.name !== undefined) {\n    db.mutate('UPDATE files SET name = ? WHERE id = ?', [params.name, fileId]);\n  }\n  if ('encryptMeta' in params) {\n    db.mutate('UPDATE files SET encrypt_meta = ? WHERE id = ?', [\n      params.encryptMeta ?? null,\n      fileId,\n    ]);\n  }\n  if ('encryptSalt' in params) {\n    db.mutate('UPDATE files SET encrypt_salt = ? WHERE id = ?', [\n      params.encryptSalt ?? null,\n      fileId,\n    ]);\n  }\n  if ('encryptKeyId' in params) {\n    db.mutate('UPDATE files SET encrypt_key_id = ? WHERE id = ?', [\n      params.encryptKeyId ?? null,\n      fileId,\n    ]);\n  }\n  if ('encryptTest' in params) {\n    db.mutate('UPDATE files SET encrypt_test = ? WHERE id = ?', [\n      params.encryptTest ?? null,\n      fileId,\n    ]);\n  }\n  if ('deleted' in params && params.deleted !== undefined) {\n    db.mutate('UPDATE files SET deleted = ? WHERE id = ?', [\n      params.deleted ? 1 : 0,\n      fileId,\n    ]);\n  }\n}\n\nexport function findUsersWithAccess(\n  fileId: string,\n): Array<{ userId: string; displayName: string | null }> {\n  return getAccountDb().all(\n    `SELECT ua.user_id as userId, u.display_name as displayName\n     FROM user_access ua\n     JOIN users u ON u.id = ua.user_id\n     WHERE ua.file_id = ?`,\n    [fileId],\n  );\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;;;AACD;;AA4BO,MAAM,qBAAqB;IAChC,YAAY,MAAc,CAAE;QAC1B,KAAK,CAAC,CAAC,gBAAgB,EAAE,QAAQ;IACnC;AACF;AAEA,SAAS,QAAQ,GAAe;IAC9B,OAAO;QACL,IAAI,IAAI,EAAE;QACV,SAAS,IAAI,QAAQ;QACrB,aAAa,IAAI,YAAY;QAC7B,MAAM,IAAI,IAAI;QACd,aAAa,IAAI,YAAY;QAC7B,aAAa,IAAI,YAAY;QAC7B,cAAc,IAAI,cAAc;QAChC,aAAa,IAAI,YAAY;QAC7B,OAAO,IAAI,KAAK;QAChB,SAAS,IAAI,OAAO;IACtB;AACF;AAEO,SAAS,QAAQ,MAAc;IACpC,MAAM,MAAM,IAAA,yKAAY,IAAG,KAAK,CAC9B,CAAC;;4BAEuB,CAAC,EACzB;QAAC;KAAO;IAEV,IAAI,CAAC,KAAK,MAAM,IAAI,aAAa;IACjC,OAAO,QAAQ;AACjB;AAEO,SAAS,UAAU,MAA0B;IAClD,MAAM,OAAO,IAAA,yKAAY,IAAG,GAAG,CAC7B,CAAC;;;;;MAKC,CAAC,EACH;QAAC,OAAO,MAAM;QAAE,OAAO,MAAM;KAAC;IAEhC,OAAO,KAAK,GAAG,CAAC;AAClB;AAWO,SAAS,QAAQ,MAAqB;IAC3C,IAAA,yKAAY,IAAG,MAAM,CACnB,CAAC;iCAC4B,CAAC,EAC9B;QACE,OAAO,EAAE;QACT,OAAO,OAAO;QACd,OAAO,WAAW;QAClB,OAAO,IAAI;QACX,OAAO,WAAW;QAClB,OAAO,KAAK;KACb;AAEL;AAaO,SAAS,WAAW,MAAc,EAAE,MAAwB;IACjE,MAAM,KAAK,IAAA,yKAAY;IAEvB,IAAI,aAAa,QAAQ;QACvB,GAAG,MAAM,CAAC,8CAA8C;YACtD,OAAO,OAAO,IAAI;YAClB;SACD;IACH;IACA,IAAI,iBAAiB,QAAQ;QAC3B,GAAG,MAAM,CAAC,kDAAkD;YAC1D,OAAO,WAAW,IAAI;YACtB;SACD;IACH;IACA,IAAI,UAAU,UAAU,OAAO,IAAI,KAAK,WAAW;QACjD,GAAG,MAAM,CAAC,0CAA0C;YAAC,OAAO,IAAI;YAAE;SAAO;IAC3E;IACA,IAAI,iBAAiB,QAAQ;QAC3B,GAAG,MAAM,CAAC,kDAAkD;YAC1D,OAAO,WAAW,IAAI;YACtB;SACD;IACH;IACA,IAAI,iBAAiB,QAAQ;QAC3B,GAAG,MAAM,CAAC,kDAAkD;YAC1D,OAAO,WAAW,IAAI;YACtB;SACD;IACH;IACA,IAAI,kBAAkB,QAAQ;QAC5B,GAAG,MAAM,CAAC,oDAAoD;YAC5D,OAAO,YAAY,IAAI;YACvB;SACD;IACH;IACA,IAAI,iBAAiB,QAAQ;QAC3B,GAAG,MAAM,CAAC,kDAAkD;YAC1D,OAAO,WAAW,IAAI;YACtB;SACD;IACH;IACA,IAAI,aAAa,UAAU,OAAO,OAAO,KAAK,WAAW;QACvD,GAAG,MAAM,CAAC,6CAA6C;YACrD,OAAO,OAAO,GAAG,IAAI;YACrB;SACD;IACH;AACF;AAEO,SAAS,oBACd,MAAc;IAEd,OAAO,IAAA,yKAAY,IAAG,GAAG,CACvB,CAAC;;;yBAGoB,CAAC,EACtB;QAAC;KAAO;AAEZ","debugId":null}},
    {"offset": {"line": 458, "column": 0}, "map": {"version":3,"sources":["file:///home/nodes/development/actual-nextgen/packages/web/src/server/session.ts"],"sourcesContent":["/**\n * Session validation for API routes.\n * Checks the `x-actual-token` header (legacy token from sync-server).\n * This allows the mobile apps and @actual-app/api package to work unchanged.\n */\nimport { type NextRequest, NextResponse } from 'next/server';\n\nimport {\n  type Session,\n  TOKEN_EXPIRATION_NEVER,\n  getSession,\n} from './db/account-db';\n\ntype SessionResult =\n  | { ok: true; session: Session }\n  | { ok: false; response: NextResponse };\n\nconst MS_PER_SECOND = 1000;\n\nexport function requireSession(request: NextRequest): SessionResult {\n  const token =\n    request.headers.get('x-actual-token') ??\n    request.headers.get('authorization')?.replace(/^Bearer /, '');\n\n  if (!token) {\n    return {\n      ok: false,\n      response: NextResponse.json(\n        { status: 'error', reason: 'unauthorized', details: 'token-not-found' },\n        { status: 401 },\n      ),\n    };\n  }\n\n  const session = getSession(token);\n\n  if (!session) {\n    return {\n      ok: false,\n      response: NextResponse.json(\n        { status: 'error', reason: 'unauthorized', details: 'token-not-found' },\n        { status: 401 },\n      ),\n    };\n  }\n\n  if (\n    session.expires_at !== TOKEN_EXPIRATION_NEVER &&\n    session.expires_at * MS_PER_SECOND <= Date.now()\n  ) {\n    return {\n      ok: false,\n      response: NextResponse.json(\n        { status: 'error', reason: 'token-expired' },\n        { status: 401 },\n      ),\n    };\n  }\n\n  return { ok: true, session };\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AACD;AAEA;;;AAUA,MAAM,gBAAgB;AAEf,SAAS,eAAe,OAAoB;IACjD,MAAM,QACJ,QAAQ,OAAO,CAAC,GAAG,CAAC,qBACpB,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB,QAAQ,YAAY;IAE5D,IAAI,CAAC,OAAO;QACV,OAAO;YACL,IAAI;YACJ,UAAU,gJAAY,CAAC,IAAI,CACzB;gBAAE,QAAQ;gBAAS,QAAQ;gBAAgB,SAAS;YAAkB,GACtE;gBAAE,QAAQ;YAAI;QAElB;IACF;IAEA,MAAM,UAAU,IAAA,uKAAU,EAAC;IAE3B,IAAI,CAAC,SAAS;QACZ,OAAO;YACL,IAAI;YACJ,UAAU,gJAAY,CAAC,IAAI,CACzB;gBAAE,QAAQ;gBAAS,QAAQ;gBAAgB,SAAS;YAAkB,GACtE;gBAAE,QAAQ;YAAI;QAElB;IACF;IAEA,IACE,QAAQ,UAAU,KAAK,mLAAsB,IAC7C,QAAQ,UAAU,GAAG,iBAAiB,KAAK,GAAG,IAC9C;QACA,OAAO;YACL,IAAI;YACJ,UAAU,gJAAY,CAAC,IAAI,CACzB;gBAAE,QAAQ;gBAAS,QAAQ;YAAgB,GAC3C;gBAAE,QAAQ;YAAI;QAElB;IACF;IAEA,OAAO;QAAE,IAAI;QAAM;IAAQ;AAC7B","debugId":null}},
    {"offset": {"line": 518, "column": 0}, "map": {"version":3,"sources":["file:///home/nodes/development/actual-nextgen/packages/web/src/app/api/sync/list-user-files/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from 'next/server';\n\nimport { findFiles, findUsersWithAccess } from '@/server/db/files-service';\nimport { requireSession } from '@/server/session';\n\nexport function GET(request: NextRequest) {\n  const sessionResult = requireSession(request);\n  if (!sessionResult.ok) return sessionResult.response;\n  const { session } = sessionResult;\n\n  const files = findFiles({ userId: session.user_id });\n\n  return NextResponse.json({\n    status: 'ok',\n    data: files.map((file) => ({\n      deleted: file.deleted,\n      fileId: file.id,\n      groupId: file.groupId,\n      name: file.name,\n      encryptKeyId: file.encryptKeyId,\n      owner: file.owner,\n      usersWithAccess: findUsersWithAccess(file.id).map((access) => ({\n        ...access,\n        owner: access.userId === file.owner,\n      })),\n    })),\n  });\n}\n"],"names":[],"mappings":";;;;AAAA;AAEA;AACA;;;;AAEO,SAAS,IAAI,OAAoB;IACtC,MAAM,gBAAgB,IAAA,+JAAc,EAAC;IACrC,IAAI,CAAC,cAAc,EAAE,EAAE,OAAO,cAAc,QAAQ;IACpD,MAAM,EAAE,OAAO,EAAE,GAAG;IAEpB,MAAM,QAAQ,IAAA,yKAAS,EAAC;QAAE,QAAQ,QAAQ,OAAO;IAAC;IAElD,OAAO,gJAAY,CAAC,IAAI,CAAC;QACvB,QAAQ;QACR,MAAM,MAAM,GAAG,CAAC,CAAC,OAAS,CAAC;gBACzB,SAAS,KAAK,OAAO;gBACrB,QAAQ,KAAK,EAAE;gBACf,SAAS,KAAK,OAAO;gBACrB,MAAM,KAAK,IAAI;gBACf,cAAc,KAAK,YAAY;gBAC/B,OAAO,KAAK,KAAK;gBACjB,iBAAiB,IAAA,mLAAmB,EAAC,KAAK,EAAE,EAAE,GAAG,CAAC,CAAC,SAAW,CAAC;wBAC7D,GAAG,MAAM;wBACT,OAAO,OAAO,MAAM,KAAK,KAAK,KAAK;oBACrC,CAAC;YACH,CAAC;IACH;AACF","debugId":null}}]
}